# Mail Server Test Results for mail.smtpy.fr

## Summary

I've created comprehensive testing tools for your mail.smtpy.fr SMTP server. Here's what was created and the current status.

## Created Files

### 1. `test-mail-smtpy.sh` - Comprehensive Testing Script
Automated bash script that tests 13 different aspects of your mail server:
- DNS A record resolution
- Reverse DNS (PTR) records
- MX records
- SPF records
- DMARC records
- DKIM records
- SMTP port connectivity
- Server banner verification
- STARTTLS support
- DNS performance
- Blacklist checking guidance
- Port security verification

**Usage:**
```bash
./test-mail-smtpy.sh
```

### 2. `MAIL_TESTING_COMMANDS.md` - Manual Testing Reference
Comprehensive guide with individual commands for manual testing, including:
- DNS verification commands
- SMTP connectivity tests
- Docker container checks
- Email deliverability tests
- Troubleshooting commands

### 3. CI/CD Integration
Added the test script to `.github/workflows/ci-cd.yml` in the health check step. It runs automatically after deployment to validate your mail server configuration.

## Current Test Results

### ✅ Passing Tests (6)

1. **DNS A Record** - ✓ mail.smtpy.fr resolves to 45.80.25.57
2. **IP Match** - ✓ IP matches expected value
3. **PTR Record Exists** - ✓ Reverse DNS is configured
4. **DNS Performance** - ✓ Fast resolution (5ms)
5. **Port 1025 Security** - ✓ Internal port not publicly accessible (correct)
6. **PTR Record** - ✓ Present but needs update

### ⚠️ Warnings & Issues (5)

1. **PTR Record Mismatch** ⚠️
   - Current: `838987011.box.freepro.com`
   - Expected: `mail.smtpy.fr`
   - **Action**: Contact your hosting provider (Freepro) to update PTR record

2. **No MX Record** ❌
   - No MX record found for smtpy.fr
   - **Action**: Add DNS record:
     ```
     smtpy.fr. IN MX 10 mail.smtpy.fr.
     ```

3. **No SPF Record** ❌
   - **Action**: Add DNS TXT record:
     ```
     smtpy.fr. IN TXT "v=spf1 ip4:45.80.25.57 ~all"
     ```

4. **No DMARC Record** ❌
   - **Action**: Add DNS TXT record:
     ```
     _dmarc.smtpy.fr. IN TXT "v=DMARC1; p=quarantine; rua=mailto:dmarc@smtpy.fr"
     ```

5. **SMTP Port 25 Not Accessible** ❌
   - Cannot connect to port 25 from external network
   - **Possible Causes**:
     - Firewall blocking port 25
     - SMTP server not running or not bound to public interface
     - ISP blocking port 25 (common for residential/some cloud providers)
   - **Action**:
     ```bash
     # On your server:
     sudo ufw allow 25/tcp
     sudo ufw status

     # Check if SMTP is listening
     sudo netstat -tlnp | grep :25
     sudo ss -tlnp | grep :25

     # Check Docker port mapping
     docker ps | grep smtp
     ```

6. **DKIM Not Configured** ⚠️
   - DKIM keys are generated automatically by SMTPy after domain verification
   - Will be available once domain is verified in the application

## Required DNS Configuration

Add these DNS records to your domain registrar (smtpy.fr):

```dns
# MX Record (Priority 10)
smtpy.fr.                    IN MX    10 mail.smtpy.fr.

# A Record (if not already present)
mail.smtpy.fr.              IN A     45.80.25.57

# SPF Record
smtpy.fr.                    IN TXT   "v=spf1 ip4:45.80.25.57 ~all"

# DMARC Record
_dmarc.smtpy.fr.            IN TXT   "v=DMARC1; p=quarantine; rua=mailto:dmarc@smtpy.fr"

# DKIM Record (will be generated by SMTPy)
default._domainkey.smtpy.fr. IN TXT   "v=DKIM1; k=rsa; p=<public-key-from-app>"
```

## Required Server Configuration

### 1. Firewall Rules
```bash
# On your production server (45.80.25.57)
sudo ufw allow 25/tcp        # SMTP
sudo ufw allow 587/tcp       # Submission (optional)
sudo ufw allow out 25/tcp    # Outbound SMTP
sudo ufw status
```

### 2. Reverse DNS (PTR Record)
Contact your hosting provider (Freepro) to set:
```
45.80.25.57 → mail.smtpy.fr
```

This is critical for email deliverability. Many mail servers reject emails from IPs without proper reverse DNS.

### 3. SMTP Server Port Binding
Verify Docker is exposing port 25 correctly:
```bash
# Check current port mappings
docker ps | grep smtp

# Check docker-compose configuration
grep -A5 "ports:" docker-compose.prod.yml | grep -A5 smtp
```

## Testing Workflow

### Quick Test
```bash
./test-mail-smtpy.sh
```

### Individual DNS Tests
```bash
# Test A record
dig +short A mail.smtpy.fr

# Test PTR record
dig -x 45.80.25.57 +short

# Test MX record
dig +short MX smtpy.fr

# Test SPF record
dig +short TXT smtpy.fr | grep spf

# Test DMARC record
dig +short TXT _dmarc.smtpy.fr
```

### SMTP Connectivity Test
```bash
# Test port 25
nc -zv mail.smtpy.fr 25

# Test SMTP banner
echo "QUIT" | nc mail.smtpy.fr 25

# Test STARTTLS
echo "EHLO test.com" | openssl s_client -starttls smtp -connect mail.smtpy.fr:25 -brief
```

### From Production Server
```bash
# Check if SMTP is listening
sudo netstat -tlnp | grep :25

# Check if port 25 is accessible internally
nc -zv localhost 25

# Check firewall
sudo ufw status | grep 25
```

## Next Steps

1. **Add DNS Records** - Configure MX, SPF, and DMARC records at your DNS provider
2. **Update PTR Record** - Contact Freepro to update reverse DNS
3. **Configure Firewall** - Open port 25 on your server
4. **Verify SMTP Service** - Ensure SMTP container is running and bound to port 25
5. **Test Email Delivery** - Send test email and check with https://www.mail-tester.com/
6. **Monitor Blacklists** - Check your IP isn't blacklisted at:
   - https://mxtoolbox.com/blacklists.aspx
   - https://multirbl.valli.org/lookup/

## CI/CD Integration

The test script now runs automatically after each deployment in the GitHub Actions workflow. It will:
- Validate DNS configuration
- Check SMTP connectivity
- Verify security settings
- Report any issues

The script uses `|| true` so DNS issues won't fail the deployment, but results will be visible in the GitHub Actions logs.

## Monitoring

For continuous monitoring:
```bash
# Watch SMTP logs
docker logs -f smtpy-smtp-prod

# Monitor port 25
watch -n 5 'nc -zv mail.smtpy.fr 25 2>&1'

# Check DNS in real-time
watch -n 60 'dig +short MX smtpy.fr'
```

## Troubleshooting

If issues persist:

1. **Check Docker Compose Configuration**
   ```bash
   cat docker-compose.prod.yml | grep -A20 "smtp:"
   ```

2. **Check SMTP Server Logs**
   ```bash
   docker logs smtpy-smtp-prod --tail 100
   ```

3. **Verify Environment Variables**
   ```bash
   docker exec smtpy-smtp-prod env | grep SMTP
   ```

4. **Test Internal Connectivity**
   ```bash
   docker exec smtpy-smtp-prod python -c "import socket; s=socket.socket(); s.connect(('localhost', 1025)); print('Connected')"
   ```

## References

- Deployment Guide: `docs/DEPLOYMENT_GUIDE.md`
- SMTP Relay README: `back/smtp/relay/README.md`
- Test Commands: `MAIL_TESTING_COMMANDS.md`
- Environment Template: `.env.production.template`
