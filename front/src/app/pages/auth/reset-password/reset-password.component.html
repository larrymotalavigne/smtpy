<div class="auth-container">
  <div class="auth-content auth-content-small">
    <!-- Logo Section -->
    <div class="auth-header">
      <div class="auth-logo">
        <h1 class="logo-text">SMTPy</h1>
      </div>
      <h2 class="auth-title">Réinitialiser le mot de passe</h2>
      <p class="auth-subtitle">Créez un nouveau mot de passe sécurisé</p>
    </div>

    <!-- Reset Password Form Card -->
    <p-card class="auth-card">
      <ng-template #content>
        <!-- Success State -->
        @if (resetSuccess) {
          <div class="success-state">
            <div class="success-icon">
              <i class="pi pi-check-circle"></i>
            </div>
            <h3 class="success-title">Mot de passe réinitialisé!</h3>
            <p-message severity="success"
              text="Votre mot de passe a été modifié avec succès."
              styleClass="w-full mb-4" />
            <p class="success-description">
              Vous allez être redirigé vers la page de connexion dans quelques secondes...
            </p>
            <div class="success-actions">
              <p-button label="Se connecter maintenant"
                icon="pi pi-sign-in"
                routerLink="/auth/login"
                styleClass="w-full" />
            </div>
          </div>
        }

        <!-- Invalid Token State -->
        @if (tokenInvalid && !resetSuccess) {
          <div class="error-state">
            <div class="error-icon">
              <i class="pi pi-times-circle"></i>
            </div>
            <h3 class="error-title">Lien invalide</h3>
            <p-message severity="error"
              [text]="errorMessage"
              styleClass="w-full mb-4" />
            <p class="error-description">
              Ce lien de réinitialisation est invalide ou a expiré. Les liens de réinitialisation ne sont valables que pendant 1 heure.
            </p>
            <div class="error-actions">
              <p-button label="Demander un nouveau lien"
                icon="pi pi-refresh"
                (onClick)="requestNewLink()"
                styleClass="w-full mb-3" />
              <p-button label="Retour à la connexion"
                icon="pi pi-arrow-left"
                [outlined]="true"
                routerLink="/auth/login"
                styleClass="w-full" />
            </div>
          </div>
        }

        <!-- Form State -->
        @if (!resetSuccess && !tokenInvalid) {
          <form [formGroup]="resetPasswordForm" (ngSubmit)="onSubmit()" class="auth-form">
            <!-- Error Message -->
            @if (errorMessage) {
              <p-message severity="error"
                [text]="errorMessage"
                styleClass="w-full mb-4" />
            }
            <!-- Info Message -->
            <p-message severity="info"
              text="Créez un mot de passe fort avec au moins 8 caractères"
              styleClass="w-full mb-4" />
            <!-- New Password Field -->
            <div class="form-field">
              <label for="password" class="form-label">
                Nouveau mot de passe
                <span class="required">*</span>
              </label>
              <div class="input-wrapper">
                <i class="pi pi-lock input-icon"></i>
                <p-password id="password"
                  data-testid="reset-password-field"
                  formControlName="password"
                  placeholder="Entrez votre nouveau mot de passe"
                  [toggleMask]="true"
                  [feedback]="true"
                  [class.invalid]="isFieldInvalid('password')"
                  autocomplete="new-password"
                  styleClass="w-full"
                  inputStyleClass="w-full"
                  promptLabel="Entrez un mot de passe"
                  weakLabel="Faible"
                  mediumLabel="Moyen"
                  strongLabel="Fort" />
              </div>
              @if (isFieldInvalid('password')) {
                <small class="form-error">
                  {{ getFieldError('password') }}
                </small>
              }
              @if (!isFieldInvalid('password')) {
                <small class="form-hint">
                  Minimum 8 caractères avec majuscule, minuscule et chiffre
                </small>
              }
            </div>
            <!-- Confirm Password Field -->
            <div class="form-field">
              <label for="confirmPassword" class="form-label">
                Confirmer le mot de passe
                <span class="required">*</span>
              </label>
              <div class="input-wrapper">
                <i class="pi pi-lock input-icon"></i>
                <p-password id="confirmPassword"
                  data-testid="reset-confirm-password-field"
                  formControlName="confirmPassword"
                  placeholder="Confirmez votre nouveau mot de passe"
                  [toggleMask]="true"
                  [feedback]="false"
                  [class.invalid]="isFieldInvalid('confirmPassword') || getPasswordMatchError()"
                  autocomplete="new-password"
                  styleClass="w-full"
                  inputStyleClass="w-full" />
              </div>
              @if (isFieldInvalid('confirmPassword')) {
                <small class="form-error">
                  {{ getFieldError('confirmPassword') }}
                </small>
              }
              @if (getPasswordMatchError()) {
                <small class="form-error">
                  {{ getPasswordMatchError() }}
                </small>
              }
            </div>
            <!-- Submit Button -->
            <p-button type="submit"
              data-testid="reset-password-submit-button"
              label="Réinitialiser le mot de passe"
              icon="pi pi-check"
              [loading]="loading"
              [disabled]="loading"
              styleClass="w-full submit-button" />
            <!-- Back to Login -->
            <div class="auth-footer">
              <a routerLink="/auth/login" class="back-link">
                <i class="pi pi-arrow-left"></i>
                Retour à la connexion
              </a>
            </div>
          </form>
        }
      </ng-template>
    </p-card>

    <!-- Back to Home -->
    <div class="back-to-home">
      <a routerLink="/" class="home-link">
        <i class="pi pi-arrow-left"></i>
        Retour à l'accueil
      </a>
    </div>
  </div>
</div>

<!-- Toast for notifications -->
<p-toast />
