<div class="statistics-container">
    <!-- Header -->
    <div class="statistics-header">
        <div>
            <h1 class="page-title">Statistiques d'utilisation</h1>
            <p class="page-subtitle">Analysez vos données de messagerie en temps réel</p>
        </div>
        <div class="header-actions">
            <p-button #exportBtn
                      type="button"
                      label="Exporter"
                      icon="pi pi-download"
                      [outlined]="true"
                      (onClick)="exportMenu.toggle($event)"/>
            <p-menu #exportMenu [model]="exportMenuItems" [popup]="true"/>
        </div>
    </div>

    <!-- Filters -->
    <p-card class="filters-card">
        <ng-template pTemplate="content">
            <div class="filters-grid">
                <div class="filter-item">
                    <label for="period">Période:</label>
                    <p-select id="period"
                              [(ngModel)]="selectedPeriod"
                              [options]="periodOptions"
                              optionLabel="label"
                              (onChange)="onPeriodChange()"
                              class="w-full"/>
                </div>
                @if (selectedPeriod.value === 'custom') {
                    <div class="filter-item">
                        <label for="dateRange">Plage de dates:</label>
                        <p-datepicker id="dateRange"
                                      [(ngModel)]="dateRange"
                                      selectionMode="range"
                                      [showIcon]="true"
                                      dateFormat="dd/mm/yy"
                                      placeholder="Sélectionner une plage"
                                      (onSelect)="onDateRangeChange()"
                                      class="w-full"/>
                    </div>
                }
            </div>
        </ng-template>
    </p-card>

    <!-- Overall Statistics Cards -->
    @if (!loading && overallStats) {
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-icon success">
                    <i class="pi pi-check-circle"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-label">Total emails</span>
                    <span class="stat-value">{{ overallStats.total_emails | number }}</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon primary">
                    <i class="pi pi-send"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-label">Emails envoyés</span>
                    <span class="stat-value">{{ overallStats.emails_sent | number }}</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon danger">
                    <i class="pi pi-times-circle"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-label">Emails échoués</span>
                    <span class="stat-value">{{ overallStats.emails_failed | number }}</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon info">
                    <i class="pi pi-percentage"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-label">Taux de succès</span>
                    <span class="stat-value">{{ overallStats.success_rate | number:'1.1-1' }}%</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon warning">
                    <i class="pi pi-globe"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-label">Domaines actifs</span>
                    <span class="stat-value">{{ overallStats.active_domains | number }}</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon secondary">
                    <i class="pi pi-at"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-label">Alias actifs</span>
                    <span class="stat-value">{{ overallStats.active_aliases | number }}</span>
                </div>
            </div>
        </div>
    }@else{
        <div class="stats-cards">
            @for (i of [1,2,3,4,5,6]; track i) {
                <div class="stat-card">
                    <p-skeleton width="3rem" height="3rem" borderRadius="50%"/>
                    <div class="stat-content">
                        <p-skeleton width="8rem" height="1rem" class="mb-2"/>
                        <p-skeleton width="4rem" height="1.5rem"/>
                    </div>
                </div>
            }
        </div>
    }

    <!-- Charts Section -->
    <div class="charts-grid">
        <!-- Time Series Chart -->
        <p-card class="chart-card">
            <ng-template #header>
                <div class="card-header">
                    <h3>Volume d'emails dans le temps</h3>
                </div>
            </ng-template>
            <ng-template #content>
                @if (!loading) {
                    <div class="chart-wrapper">
                        <canvas #timeSeriesCanvas></canvas>
                    </div>
                } @else {
                    <p-skeleton height="300px"/>
                }
            </ng-template>
        </p-card>

        <!-- Domain Breakdown Chart -->
        <p-card class="chart-card">
            <ng-template pTemplate="header">
                <div class="card-header">
                    <h3>Répartition par domaine</h3>
                </div>
            </ng-template>
            <ng-template pTemplate="content">
                @if (!loading && domainStats.length > 0) {
                    <div class="chart-wrapper domain-chart">
                        <canvas #domainBreakdownCanvas></canvas>
                    </div>
                } @else {
                    <p-skeleton height="300px"/>

                }
            </ng-template>
        </p-card>
    </div>

    <!-- Domain Statistics Table -->
    @if (!loading && domainStats.length > 0) {
        <p-card class="table-card">
            <ng-template pTemplate="header">
                <div class="card-header">
                    <h3>Statistiques par domaine</h3>
                </div>
            </ng-template>
            <ng-template pTemplate="content">
                <p-table
                    [value]="domainStats"
                    [paginator]="false"
                    [tableStyle]="{ 'min-width': '60rem' }"
                    class="p-datatable-sm">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Domaine</th>
                            <th class="text-right">Total emails</th>
                            <th class="text-right">Envoyés</th>
                            <th class="text-right">Échoués</th>
                            <th class="text-right">Taux de succès</th>
                            <th class="text-right">% du total</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-domain>
                        <tr>
                            <td>
                                <div class="domain-cell">
                                    <i class="pi pi-globe"></i>
                                    <span class="domain-name">{{ domain.domain_name }}</span>
                                </div>
                            </td>
                            <td class="text-right">
                                <span class="stat-number">{{ domain.email_count | number }}</span>
                            </td>
                            <td class="text-right">
                                <span class="stat-number success">{{ domain.success_count | number }}</span>
                            </td>
                            <td class="text-right">
                                <span class="stat-number danger">{{ domain.failure_count | number }}</span>
                            </td>
                            <td class="text-right">
                                <div class="success-rate" [class.high]="domain.success_rate >= 95"
                                     [class.medium]="domain.success_rate >= 85 && domain.success_rate < 95"
                                     [class.low]="domain.success_rate < 85">
                                    <i class="pi" [class.pi-check-circle]="domain.success_rate >= 95"
                                       [class.pi-exclamation-triangle]="domain.success_rate >= 85 && domain.success_rate < 95"
                                       [class.pi-times-circle]="domain.success_rate < 85"></i>
                                    <span>{{ domain.success_rate | number:'1.1-1' }}%</span>
                                </div>
                            </td>
                            <td class="text-right">
                                <span class="percentage">{{ domain.percentage_of_total | number:'1.1-1' }}%</span>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </ng-template>
        </p-card>
    }

    <!-- Top Aliases Table -->
    @if (!loading && topAliases.length > 0) {
        <p-card class="table-card">
            <ng-template pTemplate="header">
                <div class="card-header">
                    <h3>Top des alias les plus utilisés</h3>
                </div>
            </ng-template>
            <ng-template pTemplate="content">
                <p-table
                    [value]="topAliases"
                    [paginator]="false"
                    [tableStyle]="{ 'min-width': '50rem' }"
                    class="p-datatable-sm">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Alias</th>
                            <th>Domaine</th>
                            <th class="text-right">Emails reçus</th>
                            <th class="text-right">Dernière utilisation</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-alias let-i="rowIndex">
                        <tr>
                            <td>
                                <div class="alias-cell">
                                    <span class="rank-badge">{{ i + 1 }}</span>
                                    <i class="pi pi-at"></i>
                                    <span class="alias-email">{{ alias.alias_email }}</span>
                                </div>
                            </td>
                            <td>
                                <span class="domain-badge">{{ alias.domain_name }}</span>
                            </td>
                            <td class="text-right">
                                <span class="stat-number">{{ alias.email_count | number }}</span>
                            </td>
                            <td class="text-right">
                                <span class="date-text">{{ formatDate(alias.last_used) }}</span>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </ng-template>
        </p-card>
    }

    <!-- Empty State -->
    @if (!loading && (!overallStats || overallStats.total_emails === 0)) {
        <p-card class="empty-state">
            <ng-template pTemplate="content">
                <div class="empty-content">
                    <i class="pi pi-chart-bar"></i>
                    <h3>Aucune donnée disponible</h3>
                    <p>Il n'y a pas encore de statistiques pour la période sélectionnée</p>
                </div>
            </ng-template>
        </p-card>
    }
</div>

<!-- Toast for notifications -->
<p-toast/>
