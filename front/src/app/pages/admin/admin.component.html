<div class="admin-container">
  <!-- Header -->
  <div class="admin-header">
    <div>
      <h1 class="page-title">
        <i class="pi pi-shield"></i>
        Administration
      </h1>
      <p class="page-subtitle">Vue d'ensemble du syst√®me et statistiques globales</p>
    </div>
    <p-button
      label="Actualiser"
      icon="pi pi-refresh"
      (onClick)="refreshData()"
      [loading]="loading" />
  </div>

  <!-- System Health Cards -->
  @if (systemHealth) {
    <div class="health-cards">
      <p-card class="health-card">
        <ng-template #header>
          <div class="card-header">
            <i class="pi pi-database"></i>
            <h3>Base de donn√©es</h3>
          </div>
        </ng-template>
        <ng-template #content>
          <div class="health-content">
            <p-tag
              [value]="systemHealth.database.status"
              [severity]="getHealthStatusSeverity(systemHealth.database.status)" />
            <div class="health-details">
              <span>Connexions: {{ systemHealth.database.connections }}</span>
              <span>Taille: {{ systemHealth.database.size }}</span>
            </div>
          </div>
        </ng-template>
      </p-card>

      @if (systemHealth.redis) {
        <p-card class="health-card">
          <ng-template #header>
            <div class="card-header">
              <i class="pi pi-server"></i>
              <h3>Redis</h3>
            </div>
          </ng-template>
          <ng-template #content>
            <div class="health-content">
              <p-tag
                [value]="systemHealth.redis.status"
                [severity]="getHealthStatusSeverity(systemHealth.redis.status)" />
              <div class="health-details">
                <span>M√©moire: {{ systemHealth.redis.memory_used }}</span>
              </div>
            </div>
          </ng-template>
        </p-card>
      }

      <p-card class="health-card">
        <ng-template #header>
          <div class="card-header">
            <i class="pi pi-send"></i>
            <h3>SMTP</h3>
          </div>
        </ng-template>
        <ng-template #content>
          <div class="health-content">
            <p-tag
              [value]="systemHealth.smtp.status"
              [severity]="getHealthStatusSeverity(systemHealth.smtp.status)" />
            <div class="health-details">
              <span>File d'attente: {{ systemHealth.smtp.queue_size }}</span>
            </div>
          </div>
        </ng-template>
      </p-card>
    </div>
  }

  <!-- Statistics Overview -->
  @if (!loading && stats) {
    <div class="stats-grid">
      <!-- Users Card -->
      <p-card class="stat-card">
        <ng-template #header>
          <div class="card-header">
            <i class="pi pi-users"></i>
            <h3>Utilisateurs</h3>
          </div>
        </ng-template>
        <ng-template #content>
          <div class="stat-content">
            <div class="stat-main">
              <span class="stat-number">{{ stats.users.total }}</span>
              <span class="stat-label">Total</span>
            </div>
            <div class="stat-details">
              <div class="stat-item">
                <span class="label">Actifs:</span>
                <span class="value">{{ stats.users.active }}</span>
              </div>
              <div class="stat-item">
                <span class="label">Admins:</span>
                <span class="value">{{ stats.users.admins }}</span>
              </div>
              <div class="stat-item success">
                <span class="label">Nouveaux (30j):</span>
                <span class="value">{{ stats.users.recent_signups }}</span>
              </div>
            </div>
          </div>
        </ng-template>
      </p-card>

      <!-- Organizations Card -->
      <p-card class="stat-card">
        <ng-template #header>
          <div class="card-header">
            <i class="pi pi-building"></i>
            <h3>Organisations</h3>
          </div>
        </ng-template>
        <ng-template #content>
          <div class="stat-content">
            <div class="stat-main">
              <span class="stat-number">{{ stats.organizations.total }}</span>
              <span class="stat-label">Total</span>
            </div>
            <div class="stat-details">
              <div class="stat-item">
                <span class="label">Actives:</span>
                <span class="value">{{ stats.organizations.active }}</span>
              </div>
              <div class="stat-item success">
                <span class="label">Avec abonnement:</span>
                <span class="value">{{ stats.organizations.with_subscription }}</span>
              </div>
            </div>
          </div>
        </ng-template>
      </p-card>

      <!-- Domains Card -->
      <p-card class="stat-card">
        <ng-template #header>
          <div class="card-header">
            <i class="pi pi-globe"></i>
            <h3>Domaines</h3>
          </div>
        </ng-template>
        <ng-template #content>
          <div class="stat-content">
            <div class="stat-main">
              <span class="stat-number">{{ stats.domains.total }}</span>
              <span class="stat-label">Total</span>
            </div>
            <div class="stat-details">
              <div class="stat-item success">
                <span class="label">V√©rifi√©s:</span>
                <span class="value">{{ stats.domains.verified }}</span>
              </div>
              <div class="stat-item warning">
                <span class="label">Non v√©rifi√©s:</span>
                <span class="value">{{ stats.domains.unverified }}</span>
              </div>
              <div class="stat-item">
                <span class="label">Actifs:</span>
                <span class="value">{{ stats.domains.active }}</span>
              </div>
            </div>
          </div>
        </ng-template>
      </p-card>

      <!-- Aliases Card -->
      <p-card class="stat-card">
        <ng-template #header>
          <div class="card-header">
            <i class="pi pi-at"></i>
            <h3>Alias</h3>
          </div>
        </ng-template>
        <ng-template #content>
          <div class="stat-content">
            <div class="stat-main">
              <span class="stat-number">{{ stats.aliases.total }}</span>
              <span class="stat-label">Total</span>
            </div>
            <div class="stat-details">
              <div class="stat-item success">
                <span class="label">Actifs:</span>
                <span class="value">{{ stats.aliases.active }}</span>
              </div>
              <div class="stat-item">
                <span class="label">Inactifs:</span>
                <span class="value">{{ stats.aliases.inactive }}</span>
              </div>
            </div>
          </div>
        </ng-template>
      </p-card>

      <!-- Messages Card -->
      <p-card class="stat-card messages">
        <ng-template #header>
          <div class="card-header">
            <i class="pi pi-envelope"></i>
            <h3>Messages</h3>
          </div>
        </ng-template>
        <ng-template #content>
          <div class="stat-content">
            <div class="stat-main">
              <span class="stat-number">{{ stats.messages.total }}</span>
              <span class="stat-label">Total</span>
            </div>
            <div class="stat-details">
              <div class="stat-item success">
                <span class="label">Aujourd'hui:</span>
                <span class="value">{{ stats.messages.today }}</span>
              </div>
              <div class="stat-item">
                <span class="label">Cette semaine:</span>
                <span class="value">{{ stats.messages.this_week }}</span>
              </div>
              <div class="stat-item">
                <span class="label">Ce mois:</span>
                <span class="value">{{ stats.messages.this_month }}</span>
              </div>
              @if (stats.messages.failed > 0) {
                <div class="stat-item error">
                  <span class="label">√âchecs:</span>
                  <span class="value">{{ stats.messages.failed }}</span>
                </div>
              }
            </div>
          </div>
        </ng-template>
      </p-card>
    </div>

    <!-- Charts Section -->
    <div class="charts-grid">
      <p-card class="chart-card">
        <ng-template #header>
          <h3>Statut des domaines</h3>
        </ng-template>
        <ng-template #content>
          <p-chart type="pie" [data]="domainStatusData" [options]="chartOptions" />
        </ng-template>
      </p-card>

      <p-card class="chart-card">
        <ng-template #header>
          <h3>R√©partition des abonnements</h3>
        </ng-template>
        <ng-template #content>
          <p-chart type="pie" [data]="subscriptionData" [options]="chartOptions" />
        </ng-template>
      </p-card>

      <p-card class="chart-card wide">
        <ng-template #header>
          <h3>Volume de messages</h3>
        </ng-template>
        <ng-template #content>
          <p-chart type="bar" [data]="messageVolumeData" [options]="chartOptions" />
        </ng-template>
      </p-card>

      <p-card class="chart-card wide">
        <ng-template #header>
          <h3>Statistiques utilisateurs</h3>
        </ng-template>
        <ng-template #content>
          <p-chart type="line" [data]="userGrowthData" [options]="chartOptions" />
        </ng-template>
      </p-card>
    </div>
  }

  <!-- Loading State -->
  @if (loading) {
    <div class="loading-state">
      <p-skeleton height="200px" styleClass="mb-4" />
      <div class="stats-grid">
        <p-skeleton height="150px" />
        <p-skeleton height="150px" />
        <p-skeleton height="150px" />
        <p-skeleton height="150px" />
      </div>
    </div>
  }

  <!-- SMTP Configuration and Testing -->
  @if (!loading) {
    <p-card class="smtp-testing-card" styleClass="mt-4">
      <ng-template #header>
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem;">
          <div>
            <i class="pi pi-envelope"></i>
            <h3 style="display: inline; margin-left: 0.5rem;">Configuration et Tests SMTP</h3>
          </div>
          <p-button
            label="Charger Configuration"
            icon="pi pi-download"
            (onClick)="loadSMTPConfig()"
            [loading]="smtpConfigLoading"
            size="small" />
        </div>
      </ng-template>
      <ng-template #content>
        <!-- SMTP Configuration Display -->
        @if (smtpConfig) {
          <p-accordion [value]="0">
            <!-- Transactional Email Config -->
            <p-accordion-panel [value]="0">
              <p-accordion-header>üìß Configuration Email Transactionnel</p-accordion-header>
              <p-accordion-content>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                  <div>
                    <strong>Activ√©:</strong>
                    <p-tag
                      [value]="smtpConfig.transactional_email.enabled ? 'Oui' : 'Non'"
                      [severity]="smtpConfig.transactional_email.enabled ? 'success' : 'danger'" />
                  </div>
                  <div><strong>H√¥te SMTP:</strong> {{ smtpConfig.transactional_email.host }}</div>
                  <div><strong>Port:</strong> {{ smtpConfig.transactional_email.port }}</div>
                  <div><strong>Utilisateur:</strong> {{ smtpConfig.transactional_email.username || '(non configur√©)' }}</div>
                  <div>
                    <strong>Mot de passe:</strong>
                    <p-tag
                      [value]="smtpConfig.transactional_email.password_set ? 'Configur√©' : 'Non configur√©'"
                      [severity]="smtpConfig.transactional_email.password_set ? 'success' : 'warn'" />
                  </div>
                  <div>
                    <strong>TLS:</strong>
                    <p-tag [value]="smtpConfig.transactional_email.use_tls ? 'Oui' : 'Non'" />
                  </div>
                </div>
              </p-accordion-content>
            </p-accordion-panel>

            <!-- SMTP Relay Config -->
            <p-accordion-panel [value]="1">
              <p-accordion-header>üì® Configuration Relais SMTP</p-accordion-header>
              <p-accordion-content>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                  <div><strong>Nom d'h√¥te:</strong> {{ smtpConfig.smtp_relay.hostname }}</div>
                  <div><strong>Mode:</strong> {{ smtpConfig.smtp_relay.delivery_mode }}</div>
                  <div><strong>H√¥te:</strong> {{ smtpConfig.smtp_relay.host }}</div>
                  <div><strong>Port:</strong> {{ smtpConfig.smtp_relay.port }}</div>
                  <div>
                    <strong>DKIM:</strong>
                    <p-tag
                      [value]="smtpConfig.smtp_relay.enable_dkim ? 'Activ√©' : 'D√©sactiv√©'"
                      [severity]="smtpConfig.smtp_relay.enable_dkim ? 'success' : 'warn'" />
                  </div>
                </div>
              </p-accordion-content>
            </p-accordion-panel>
          </p-accordion>
        }

        <!-- Test Email Section -->
        <div style="margin-top: 2rem; padding: 1.5rem; background: var(--surface-100); border-radius: 8px;">
          <h4 style="margin-top: 0;"><i class="pi pi-send"></i> Envoyer un email de test</h4>
          <div style="display: flex; gap: 1rem; align-items: center;">
            <input
              type="email"
              pInputText
              [(ngModel)]="testEmailRecipient"
              placeholder="destinataire@example.com"
              style="flex: 1;"
              [disabled]="smtpTestLoading" />
            <p-button
              label="Envoyer Test"
              icon="pi pi-envelope"
              (onClick)="sendTestEmail()"
              [loading]="smtpTestLoading"
              [disabled]="!testEmailRecipient" />
          </div>
          <p style="margin-top: 0.5rem; color: var(--text-color-secondary); font-size: 0.875rem;">
            <i class="pi pi-info-circle"></i>
            Un email de test (r√©initialisation de mot de passe) sera envoy√© √† l'adresse indiqu√©e
          </p>
        </div>

        <!-- Diagnostics Section -->
        <div style="margin-top: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h4 style="margin: 0;"><i class="pi pi-wrench"></i> Diagnostics SMTP</h4>
            <p-button
              label="Ex√©cuter Diagnostics"
              icon="pi pi-play"
              (onClick)="runDiagnostics()"
              [loading]="smtpDiagnosticsLoading" />
          </div>

          @if (smtpDiagnostics) {
            <div style="padding: 1.5rem; background: var(--surface-50); border-radius: 8px;">
              @if (smtpDiagnostics.timestamp) {
                <p style="color: var(--text-color-secondary); margin-bottom: 1rem;">
                  <i class="pi pi-clock"></i>
                  Ex√©cut√© le: {{ smtpDiagnostics.timestamp | date:'medium':'':'fr' }}
                </p>
              }

              <!-- Transactional Email Diagnostics -->
              <div style="margin-bottom: 2rem;">
                <h5>üìß Email Transactionnel</h5>
                <div style="display: grid; gap: 0.75rem;">
                  @if (smtpDiagnostics.transactional_email.dns_resolution) {
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <i class="pi pi-globe"></i>
                      <strong>R√©solution DNS:</strong>
                      <p-tag
                        [value]="smtpDiagnostics.transactional_email.dns_resolution.status"
                        [severity]="getStatusSeverity(smtpDiagnostics.transactional_email.dns_resolution.status)" />
                      @if (smtpDiagnostics.transactional_email.dns_resolution.ip) {
                        <span>{{ smtpDiagnostics.transactional_email.dns_resolution.ip }}</span>
                      }
                    </div>
                  }

                  @if (smtpDiagnostics.transactional_email.port_connectivity) {
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <i class="pi pi-link"></i>
                      <strong>Connectivit√© Port:</strong>
                      <p-tag
                        [value]="smtpDiagnostics.transactional_email.port_connectivity.status"
                        [severity]="getStatusSeverity(smtpDiagnostics.transactional_email.port_connectivity.status)" />
                      <span>{{ smtpDiagnostics.transactional_email.port_connectivity.message }}</span>
                    </div>
                  }

                  @if (smtpDiagnostics.transactional_email.smtp_connection) {
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <i class="pi pi-server"></i>
                      <strong>Connexion SMTP:</strong>
                      <p-tag
                        [value]="smtpDiagnostics.transactional_email.smtp_connection.status"
                        [severity]="getStatusSeverity(smtpDiagnostics.transactional_email.smtp_connection.status)" />
                      @if (smtpDiagnostics.transactional_email.smtp_connection.message) {
                        <span>{{ smtpDiagnostics.transactional_email.smtp_connection.message }}</span>
                      }
                    </div>
                  }

                  @if (smtpDiagnostics.transactional_email.authentication) {
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <i class="pi pi-key"></i>
                      <strong>Authentification:</strong>
                      <p-tag
                        [value]="smtpDiagnostics.transactional_email.authentication.status"
                        [severity]="getStatusSeverity(smtpDiagnostics.transactional_email.authentication.status)" />
                      <span>{{ smtpDiagnostics.transactional_email.authentication.message }}</span>
                    </div>
                  }
                </div>
              </div>

              <!-- SMTP Relay Diagnostics -->
              <div>
                <h5>üì® Relais SMTP</h5>
                <div style="display: grid; gap: 0.75rem;">
                  @if (smtpDiagnostics.smtp_relay.dns_resolution) {
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <i class="pi pi-globe"></i>
                      <strong>R√©solution DNS:</strong>
                      <p-tag
                        [value]="smtpDiagnostics.smtp_relay.dns_resolution.status"
                        [severity]="getStatusSeverity(smtpDiagnostics.smtp_relay.dns_resolution.status)" />
                      @if (smtpDiagnostics.smtp_relay.dns_resolution.ip) {
                        <span>{{ smtpDiagnostics.smtp_relay.dns_resolution.ip }}</span>
                      }
                    </div>
                  }

                  @if (smtpDiagnostics.smtp_relay.port_connectivity) {
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <i class="pi pi-link"></i>
                      <strong>Connectivit√© Port:</strong>
                      <p-tag
                        [value]="smtpDiagnostics.smtp_relay.port_connectivity.status"
                        [severity]="getStatusSeverity(smtpDiagnostics.smtp_relay.port_connectivity.status)" />
                      <span>{{ smtpDiagnostics.smtp_relay.port_connectivity.message }}</span>
                    </div>
                  }
                </div>
              </div>
            </div>
          }
        </div>
      </ng-template>
    </p-card>
  }
  <!-- Recent Activity -->
  @if (!loading && recentActivity.length > 0) {
    <p-card class="activity-card">
      <ng-template #header>
        <div class="card-header">
          <h3>Activit√© r√©cente</h3>
        </div>
      </ng-template>
      <ng-template #content>
        <p-table [value]="recentActivity" [rows]="10" [paginator]="true">
          <ng-template #header>
            <tr>
              <th style="width: 3rem"></th>
              <th>Type</th>
              <th>Description</th>
              <th>Utilisateur</th>
              <th>Date</th>
            </tr>
          </ng-template>
          <ng-template #body let-activity>
            <tr>
              <td>
                <i [class]="'pi ' + getActivityIcon(activity.type)"></i>
              </td>
              <td>
                <p-tag
                  [value]="activity.type"
                  [severity]="getActivitySeverity(activity.type)" />
              </td>
              <td>{{ activity.description }}</td>
              <td>{{ activity.user || '-' }}</td>
              <td>{{ activity.timestamp ? (activity.timestamp | date:'short':'':'fr') : '-' }}</td>
            </tr>
          </ng-template>
        </p-table>
      </ng-template>
    </p-card>
  }
</div>

<p-toast />
