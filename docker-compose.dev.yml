# Development Docker Compose Configuration for SMTPy
#
# This file defines a development-ready deployment with:
# - Local image builds using development Dockerfiles
# - Hot reload support
# - Debug settings enabled
# - PostgreSQL database (matches production)
# - Exposed ports for easy access
#
# Usage:
#   docker-compose -f docker-compose.dev.yml up -d --build
#

services:
  # PostgreSQL Database
  db:
    container_name: smtpy-db-dev
    image: postgres:18
    environment:
      POSTGRES_DB: smtpy
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres_data_dev:/var/lib/postgresql  # PostgreSQL 18+ requires mounting at /var/lib/postgresql
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - smtpy-network

  # SMTP Server
  smtp:
    container_name: smtpy-smtp-dev
    build:
      context: .
      dockerfile: ./back/smtp/Dockerfile
    environment:
      - DATABASE_URL=postgresql+psycopg://postgres:postgres@db:5432/smtpy
      - SMTP_HOST=localhost
      - SMTP_PORT=1025
      - DEBUG=true
    ports:
      - "1025:1025"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - smtpy-network
    # Mount code for development (optional - comment out for container-only mode)
    volumes:
      - ./back/smtp:/app/smtp
      - ./back/shared:/app/shared

  # API Server
  api:
    container_name: smtpy-api-dev
    build:
      context: .
      dockerfile: ./back/api/Dockerfile
    environment:
      - DATABASE_URL=postgresql+psycopg://postgres:postgres@db:5432/smtpy
      - DEBUG=true
      - SECRET_KEY=dev-secret-key-change-in-production
      - STRIPE_API_KEY=${STRIPE_API_KEY:-}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-}
      - CORS_ORIGINS=http://localhost:4200,http://localhost:3000
      - SMTP_HOST=smtp
      - SMTP_PORT=1025
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy
      smtp:
        condition: service_started
    networks:
      - smtpy-network
    # Mount code for development (optional - comment out for container-only mode)
    volumes:
      - ./back/api:/app/api
      - ./back/shared:/app/shared
      - ./back/alembic:/app/alembic
      - ./back/alembic.ini:/app/alembic.ini
    # Override command to start API with hot reload
    # Note: Run migrations manually with: docker exec smtpy-api-dev /app/.venv/bin/python -m alembic upgrade head
    command: >
      sh -c "
        echo 'Waiting for database to be ready...' &&
        sleep 5 &&
        echo 'Starting API server with hot reload (skip migrations for now)...' &&
        uvicorn api.main:create_app --host 0.0.0.0 --port 8000 --factory --reload
      "

  # Frontend (Angular development server with hot reload)
  frontend:
    container_name: smtpy-frontend-dev
    image: node:20
    working_dir: /app
    volumes:
      - ./front:/app
      - /app/node_modules  # Prevent overwriting node_modules
    command: bash -c "npm install --legacy-peer-deps && npm start"
    ports:
      - "4200:4200"
    depends_on:
      - api
    networks:
      - smtpy-network
    environment:
      - NODE_ENV=development
    # For production-like build (nginx), use this instead:
    # build:
    #   context: ./front
    #   dockerfile: Dockerfile.prod
    # ports:
    #   - "3000:80"

# Network configuration
networks:
  smtpy-network:
    driver: bridge

# Volume configuration
volumes:
  postgres_data_dev:
    driver: local
