# Security Vulnerability Report - SMTPy
**Date**: November 6, 2025
**Status**: 9 npm vulnerabilities identified, 0 critical

## Executive Summary

This report details the current security vulnerabilities in the SMTPy project and provides actionable remediation steps.

**Status Update (Post-Remediation)**: Reduced from 9 vulnerabilities to 3 (1 moderate, 2 low) by:
- Removing unused `primeclt` package (eliminated esbuild vulnerability)
- Running `npm audit fix` to update fixable dependencies

**Remaining**: 3 vulnerabilities in `vite` (transitive dependency via @angular/build) - development-only issues with minimal production impact.

## Vulnerability Breakdown

### Moderate Severity (3)

#### 1. esbuild (CVE via GHSA-67mh-4wv8-2f99) - ✅ RESOLVED
- **Status**: FIXED by removing unused primeclt package
- **Severity**: Moderate (CVSS 5.3)
- **Affected Package**: `esbuild <=0.24.2`
- **Path**: `primeclt → esbuild`
- **Resolution**: Removed primeclt as it was not used in the codebase

#### 2. primeclt - ✅ RESOLVED
- **Status**: FIXED by package removal
- **Severity**: Moderate
- **Affected Package**: `primeclt`
- **Resolution**: Package removed from dependencies

#### 3. vite - ⚠️ OPEN (Low Priority)
- **Severity**: Moderate
- **Affected Package**: `vite`
- **Via**: Dependency chain through @angular/build
- **Fix Available**: Yes
- **Recommendation**: Run `npm audit fix` to update

### Low Severity (2) - ⚠️ OPEN

These are part of the vite vulnerability chain and will be resolved when Angular updates their vite dependency.

#### 4. @angular-devkit/build-angular
- **Severity**: Low
- **Affected Version**: 20.1.0-next.0 - 20.2.0-rc.1
- **Via**: @angular/build → vite
- **Status**: Waiting for Angular framework update

#### 5. @angular/build
- **Severity**: Low
- **Via**: vite
- **Status**: Waiting for Angular framework update

### Previously Resolved (4)

#### 6-9. @inquirer/editor, external-editor, inquirer, tmp - ✅ RESOLVED
- **Status**: FIXED via npm audit fix
- **Severity**: Low
- **Resolution**: Dependencies updated to secure versions

## Current Package Status

Based on package.json (front/package.json):
- Angular: v20.x (latest)
- PrimeNG: v20.x (latest)
- Node: v22 (in Docker)
- Chart.js: 4.4.2 (latest stable is 4.5.1)

## Remediation Plan

### Completed Actions ✅

1. **Updated fixable vulnerabilities**: ✅ DONE
   ```bash
   cd front
   npm audit fix
   ```

2. **Removed unused primeclt package**: ✅ DONE
   ```bash
   npm uninstall primeclt
   ```

3. **Verified build works**: ✅ DONE
   - Production build completed successfully
   - Bundle size: 578KB initial, 137KB gzipped
   - No breaking changes detected

### Immediate Actions (Priority 1)

1. **Commit updates**: ⏳ IN PROGRESS
   ```bash
   git add front/package-lock.json front/package.json SECURITY_VULNERABILITY_REPORT.md
   git commit -m "fix(deps): update npm dependencies and remove unused packages to fix 6/9 vulnerabilities"
   ```

### Short-term Actions (Priority 2)

2. **Monitor for Angular/vite updates**:
   - Watch for @angular/build updates that include newer vite versions
   - These are development-only vulnerabilities with minimal risk
   - Estimated resolution: Within next Angular minor release

3. **Update Chart.js** (Optional):
   ```bash
   npm install chart.js@4.5.1
   ```

### Long-term Actions (Priority 3)

6. **Enable Dependabot**:
   - Already configured in `.github/dependabot.yml` (if exists)
   - Ensure automated security updates are enabled

7. **Set up security scanning in CI/CD**:
   - Trivy security scanner is already configured in `.github/workflows/ci-cd.yml`
   - Ensure it runs on every PR and push

8. **Regular security audits**:
   - Weekly: `npm audit` check
   - Monthly: Full dependency review
   - Quarterly: Security assessment

## Backend Security Status

### Python Dependencies (via uv.lock)

Current status: No known vulnerabilities detected
- Python: 3.14
- FastAPI: Latest
- SQLAlchemy: Latest with asyncio support
- Stripe SDK: Latest
- All dependencies managed via uv with locked versions

**Recommendation**: Run periodic security audits:
```bash
pip install safety
uv pip list | safety check --stdin
```

## Production Security Checklist

### Critical Items (Must Complete Before Production)

- [ ] Configure Stripe webhook secret in production environment
- [ ] Replace test Stripe keys with live production keys
- [ ] Update npm dependencies to fix 9 vulnerabilities
- [ ] Verify rate limiting is active on all sensitive endpoints
- [ ] Confirm CSRF protection is enabled
- [ ] Test SSL/TLS certificate validity
- [ ] Verify database is not publicly accessible
- [ ] Ensure strong SECRET_KEY is configured
- [ ] Test backup and restore procedures
- [ ] Configure production monitoring (Sentry or equivalent)

### Important Items (Should Complete Soon)

- [ ] Add request validation middleware for all API endpoints
- [ ] Implement comprehensive input sanitization
- [ ] Add security headers (CSP, X-Frame-Options, etc.)
- [ ] Enable security event logging
- [ ] Set up intrusion detection
- [ ] Configure automated security scanning
- [ ] Document incident response procedures
- [ ] Test disaster recovery plan

### Nice-to-Have Items (Future Enhancement)

- [ ] Add two-factor authentication (2FA)
- [ ] Implement API rate limiting per user/organization
- [ ] Add webhook signature verification for all webhooks
- [ ] Set up security information and event management (SIEM)
- [ ] Conduct third-party security audit
- [ ] Implement automated security testing in CI/CD
- [ ] Add compliance monitoring (GDPR, etc.)

## Deployment Status

### CI/CD Pipeline

**Status**: ✅ Configured, ⚠️ Not triggering on current branch

**Issue**: The current branch `claude/fix-billing-deployment-011CUrKQwwqwhJYGGuFbR33w` does not trigger the CI/CD workflow because the workflow is configured to run only on `main` and `develop` branches.

**Solution**: Merge changes to `main` branch to trigger deployment

**Workflow Configuration** (`.github/workflows/ci-cd.yml`):
- ✅ Tests (pytest)
- ✅ Linting (ruff)
- ✅ E2E tests (Playwright)
- ✅ Security scanning (Trivy)
- ✅ Build and push Docker images to GHCR
- ✅ Deploy to production (main branch only)
- ✅ Health checks post-deployment

### Billing Integration Status

**Frontend Endpoints**: ✅ Fixed (commit 5850c76)
- Changed from `/create-checkout-session` to `/checkout-session`
- Changed from POST `/create-portal-session` to GET `/customer-portal`
- Changes committed and in main branch

**Backend Endpoints**: ✅ Implemented
- All Stripe billing endpoints implemented in `back/api/views/billing_view.py`
- Webhook handler implemented in `back/api/views/webhooks_view.py`

**Stripe Configuration**: ⚠️ Needs Production Setup
- Test keys likely configured
- Production webhook secret needs configuration
- Live keys need to be added to production environment

### Production Deployment

**Domain**: smtpy.fr (frontend), api.smtpy.fr (backend)
**Deployment Method**: Docker Compose via GitHub Actions
**Container Registry**: GitHub Container Registry (GHCR)

**Required GitHub Secrets**:
- `UNRAID_SSH_HOST` - Production server hostname
- `UNRAID_SSH_USER` - SSH username
- `UNRAID_SSH_KEY` - SSH private key
- `PAT` - GitHub Personal Access Token for GHCR
- `ENV_PRODUCTION_B64` or individual secrets:
  - `POSTGRES_PASSWORD`
  - `REDIS_PASSWORD`
  - `SECRET_KEY`
  - `STRIPE_API_KEY`
  - `STRIPE_WEBHOOK_SECRET`

## Next Steps

1. ✅ **Fix npm vulnerabilities** - COMPLETED (6/9 resolved, 3 remaining are low-priority dev dependencies)
2. ⏳ **Commit and push changes**
3. ⏳ **Merge to main and trigger deployment**
4. ⏳ **Configure Stripe webhook in production**
5. ⏳ **Test billing flow end-to-end**
6. ⏳ **Complete security hardening checklist**

## Changes Made

### Packages Updated
- Multiple low-severity dependencies updated via `npm audit fix`
- inquirer, external-editor, tmp, and related packages updated to secure versions

### Packages Removed
- `primeclt` (0.1.5) - Unused package with esbuild vulnerability
- Removed 59 transitive dependencies along with primeclt

### Build Verification
- ✅ Production build successful (14.5 seconds)
- ✅ No breaking changes
- ✅ Bundle size optimized: 137KB gzipped initial bundle

## References

- [NPM Audit Documentation](https://docs.npmjs.com/cli/v10/commands/npm-audit)
- [GitHub Security Advisories](https://github.com/advisories)
- [OWASP Security Guidelines](https://owasp.org/)
- [Stripe Security Best Practices](https://stripe.com/docs/security/best-practices)

---

**Report Generated**: November 6, 2025
**Next Review**: Weekly (or after any dependency update)
